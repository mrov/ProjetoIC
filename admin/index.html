<html>
    <head>
        <title>Máfia do vinil</title>
        <meta charset="utf-8" />
        <style type="text/css">
            body {margin: 0;}
            a:focus {outline: none;}


            header #top {background-color: #FF9900; width: 100%; height: 8.5em;}
            header img {margin: 1em;}
            header nav {background-color: #333333; float: left; width: 100%; padding: 0;}
            header nav ul {margin: 0;padding: 0;}
            header nav ul li {list-style: none; float: left;}
            header nav ul .menuat {background-color: #FFFFFF;}
            header nav ul li a {text-decoration: none; padding: 1em 1em; display: block;}
            header nav ul li .linkdesat {font-family: arial; color: #FFFFFF;}
            header nav ul .menuat a {font-family: arial; color: #000000;}
            
            .content {float: left; margin: 2em 1em; color: #003366; width: calc(100% - 2em);}
            .content h1 {font-family: arial;}
            
            /* MUSICAS */
            
            #listamusicas table thead {font-style: arial; background-color: #CCCCCC; color: #333333;}
            #listamusicas table td {padding: 0.3em;}
            
            /* USUARIOS */
            
            #listausuarios table thead {font-style: arial; background-color: #CCCCCC; color: #333333;}
            #listausuarios table td {padding: 0.3em;}
            #listausuarios table .cellon {background-color: #00ff00;}
            #listausuarios table .celloff {background-color: #ff1a1a; color: #FFFFFF;}
            
            /*  DOWNLOADS */
            
            #downloads #statusrede {position: absolute; bottom: 0; left: 0; width: 100%; height: 8em; box-sizing: border-box;}
            #downloads #statusrede #rede {float: left; width: 100%; height: 6em;}
            #downloads #statusrede #rede #bandarede {float: left; width: 10em; border-right: 1px solid #CCCCCC; height: 6em;}
            #downloads #statusrede #descpainelrede {font-style: arial; float: left; background-color: #CCCCCC; width: 100%; box-sizing: border-box; padding: 0.3em; height: 2em;}
            #downloads #statusrede #taxa {float: left; width: 100%; font-style: arial; font-size: 1.5em; color: #44FF44; text-align: center; margin-top: 1em;}
            #downloads #statusrede #rede #graficorede {float: left;}
            #downloads #statusrede #rede .canvasjs-chart-credit {display: none;} /* nada contra os créditos, mas essa div buga a altura do gráfico*/
            
            #downloads #listadownloads {width: 100%; max-height: calc(100% - (8.5em + 8em + 2em + 8em)); overflow-x: auto;}
            #listadownloads #tabeladownloads thead {font-style: arial; background-color: #CCCCCC; color: #333333;}
            #listadownloads #tabeladownloads td {padding: 0.3em;}
            #listadownloads #tabeladownloads td .downloadbar {width: 7em; height: 1em; border: 1px solid #CCCCCC; position: relative; overflow-x: hidden; overflow-y: hidden;}
            #listadownloads #tabeladownloads td .dlbarc {position: absolute; top: 0; left: 0; width: 100%; height: 1em;}
            #listadownloads #tabeladownloads td .dlbarc span {display: block; width: 7em; height: 1em; text-align: center;}
            #listadownloads #tabeladownloads td .dlbard {position: absolute; top: 0; left: 0; height: 1em;  overflow-x: hidden; overflow-y: hidden;}
            #listadownloads #tabeladownloads td .dlbard span {display: block; width: 7em; height: 1em; text-align: center; background-color: #00FF00; color: #FFFFFF;}
            
            /* LOG */
            
            #log #logmsg {color: #000000;}
        </style>
        <script src="porta.js"></script>
        <script type="text/javascript" src="canvasjs.min.js"></script>
    </head>
    <body>
        <header>
            <div id="top">
                <img src="img/top.png" />
            </div>
            <nav>
                <ul>
                    <li class="menuat"><a href="javascript: void(0)" onclick="mudapag(this, 'musicas')" class="linkdesat">Músicas</a></li>
                    <li><a href="javascript: void(0)" onclick="mudapag(this, 'downloads')" class="linkdesat">Downloads</a></li>
                    <li><a href="javascript: void(0)" onclick="mudapag(this, 'usuarios')" class="linkdesat">Usuários</a></li>
                    <li><a href="javascript: void(0)" onclick="mudapag(this, 'log')" class="linkdesat">Log</a></li>
                </ul>
            </nav>
        </header>
        <article class="tela">
            <div class="content" id="musicas" style="display: block;">
                <h1>Músicas</h1>
                <div id="listamusicas">
                    <table id="tabelamusicas">
                        <thead>
                            <td>Id</td>
                            <td>Nome da faixa</td>
                            <td>Banda/Artista</td>
                            <td>Duração</td>
                            <td>Tam</td>
                        </thead>
                        <tr>
                        </tr>
                    </table>
                    <audio>
                        <source src="" type="audio/mpeg">
                    </audio>
                </div>
            </div>
        </article>
        <article class="tela">
            <div class="content" id="downloads" style="display: none;">
                <h1>Downloads</h1>
                <div id="listadownloads">
                    <table id="tabeladownloads">
                        <thead>
                            <td>Usuário</td>
                            <td>IP</td>
                            <td>Música</td>
                            <td>Status</td>
                            <td>Tamanho</td>
                            <td>Completo</td>
                            <td>Enviado</td>
                            <td>Taxa UP</td>
                            <td>Conclusão</td>
                        </thead>
                        <tr></tr>
                        <tr>
                            <td>teste</td>
                            <td>123</td>
                            <td>ok</td>
                            <td>Enviando</td>
                            <td>1 MB</td>
                            <td style="padding: 0;">
                                <div class="downloadbar">
                                    <div class="dlbarc">
                                        <span>0%</span>
                                    </div>
                                    <div class="dlbard" style="width: 50%;">
                                        <span>0%</span>
                                    </div>
                                </div>
                            </td>
                            <td>500 KB</td>
                            <td>10 segundos</td>
                        </tr>
                    </table>
                </div>
                <div id="statusrede">
                    <span id="descpainelrede">Rede</span>
                    <div id="rede">
                        <div id="bandarede">
                            <span id="taxa">0 B/s</span>
                        </div>
                        <div id="graficorede" style="height: 6em; width: calc(100% - 10em - 2px);">a
                        </div>
                    </div>
                </div>
            </div>
        </article>
        <article class="tela">
            <div class="content" id="usuarios" style="display: none;">
                <h1>Usuários</h1>
                <div id="listausuarios">
                    <table id="tabelausuarios">
                        <thead>
                            <td>Id</td>
                            <td>Nome</td>
                            <td>IP</td>
                            <td>Status</td>
                        </thead>
                        <tr>
                        </tr>
                    </table>
                </div>
            </div>
        </article>
        <article class="tela">
            <div class="content" id="log" style="display: none;">
                <h1>Log</h1>
                <div id="logmsg">
                </div>
            </div>
        </article>
        <footer>
        </footer>
        <script type="text/javascript">
            function mudapag(obj, pag) {
                var paginas = document.getElementsByClassName("content");
                var menus = document.getElementsByTagName("li");
                for(var i = 0; i < paginas.length; i++) {
                    menus[i].className = "";
                    paginas[i].style.display = "none";
                }
                obj.parentNode.className = "menuat";
                document.getElementById(pag).style.display = "block";
            }
            
            var host = "ws://" + window.location.hostname;
            
            var musicas;
            var downloads;
            var usuarios;
            
            //MUSICAS
            
            function addMusica(id, nome, artista, duracao, tam, path) {
                var linha = document.getElementById("tabelamusicas").insertRow(-1);
                var col1 = linha.insertCell(0);
                var col2 = linha.insertCell(1);
                var col3 = linha.insertCell(2);
                var col4 = linha.insertCell(3);
                var col5 = linha.insertCell(4);
                var col6 = linha.insertCell(5);
                col1.innerHTML = id;
                col2.innerHTML = nome;
                col3.innerHTML = artista;
                
                var minutos = parseInt(duracao / 60);
                var segundos = parseInt(duracao % 60);
                
                var desctempo = minutos + ":" + segundos;
                
                col4.innerHTML = desctempo;
                
                var kb = tam / 1024;
                var mb = kb / 1024;
                var gb = mb / 1024;
                
                var desctam;
                if(parseInt(gb) > 0) desctam =  Number(gb).toFixed(2) + " GB";
                else if(parseInt(mb) > 0) desctam =  Number(mb).toFixed(2) + " MB";
                else if(parseInt(kb) > 0) desctam =  Number(kb).toFixed(2) + " KB";
                else desctam = Number(tam).toFixed(2)  + " Bytes";
                
                col5.innerHTML = desctam;
                col6.innerHTML = "<img src='img/icon_play.png' onclick=\"play(this, '" + path + "')\" class='btnplayer' />";
            }
            
            var btnplaying;
            document.getElementsByTagName("audio")[0].onended = function() {
               pause(btnplaying);
            };
            
            function play(elem, musica) {
                if(btnplaying != null) {
                    btnplaying.src = "img/icon_play.png";
                    pause(btnplaying);
                }
                
                
                if(musica != document.getElementsByTagName("audio")[0].src) {
                    document.getElementsByTagName("audio")[0].currentTime = 0;
                }
                btnplaying = elem;
                elem.src = "img/icon_pause.png";
                elem.onclick = function() {
                    pause(this);
                };
                document.getElementsByTagName("audio")[0].src = musica;
                document.getElementsByTagName("audio")[0].play();
            }
            
            function pause(elem) { //alert(document.getElementsByTagName("audio")[0].src);
                document.getElementsByTagName("audio")[0].pause();
                elem.src = "img/icon_play.png";
                var mus = document.getElementsByTagName("audio")[0].src;
                elem.onclick = function() {
                  play(this,  mus);  
                };
            }
            
            //DOWNLOADS
            
            var rede = 0;
            
            //--------------------------------------grafico, usa biblioteca pronta do canvasjs.com
            
            var dps = []; // dataPoints

            var chart = new CanvasJS.Chart("graficorede",{
                title :{
                    
                },			
                data: [{
                    type: "line",
                    dataPoints: dps 
                }]
            });

            var xVal = "0";
            var yVal = 10000;	
            var updateInterval = 500;
            var dataLength = 100;//500;

            var updateChart = function (count) {
                count = count || 1;
                
                for (var j = 0; j < count; j++) {	
                    yVal = rede;//yVal +  Math.round(5 + Math.random() *(-5-5)); //mudar para variável rede
                    dps.push({
                        x: xVal,
                        y: yVal
                    });
                    xVal++;
                };
                if (dps.length > dataLength)
                {
                    dps.shift();				
                }
                
                chart.render();		

            };

            updateChart(dataLength); 
            //setInterval(function(){updateChart()}, updateInterval);
            
            //------------------------------------------fim de cod. do canvasJS
            
            
            //DOWNLOADS
            
            function tamToString(tam) {
                var kb = tam / 1024;
                var mb = kb / 1024;
                var gb = mb / 1024;
                
                var desctam;
                if(parseInt(gb) > 0) desctam =  Number(gb).toFixed(2) + " GB";
                else if(parseInt(mb) > 0) desctam =  Number(mb).toFixed(2) + " MB";
                else if(parseInt(kb) > 0) desctam =  Number(kb).toFixed(2) + " KB";
                else desctam = Number(tam).toFixed(2)  + " Bytes";
                return desctam;       
            }
            
            function taxaString(taxa) {
                var kb = taxa / 1024;
                var mb = kb / 1024;
                var gb = mb / 1024;
                
                var desctam;
                if(parseInt(gb) > 0) desctam =  Number(gb).toFixed(0) + " GB/s";
                else if(parseInt(mb) > 0) desctam =  Number(mb).toFixed(0) + " MB/s";
                else if(parseInt(kb) > 0) desctam =  Number(kb).toFixed(0) + " KB/s";
                else desctam = Number(taxa).toFixed(0)  + " B/s";
                return desctam;       
            }
            
            function tempoString(segundos) {
                var minutos = segundos / 60;
                var horas = minutos / 60;
                
                var desctempo;
                if(parseInt(horas) > 0) {
                    var sufixo = parseInt(horas) == 1 ? " Hora" : " Horas";
                    desctempo = parseInt(horas) + sufixo;
                } else if(parseInt(minutos) > 0) {
                    var sufixo = parseInt(minutos) == 1 ? " Minuto" : " Minutos";
                    desctempo = parseInt(minutos) + sufixo;
                } else {
                    if(parseInt(segundos) == 0) segundos = 1;
                    var sufixo = parseInt(segundos) == 1 ? " Segundo" : " Segundos";
                    desctempo = parseInt(segundos) + sufixo;
                }
                return desctempo;
            }
            
            function addDownload(usuario, ip, musica, status, tam, enviado) {//enviado = 1024 * 1024 * 5;
                var linha = document.getElementById("tabeladownloads").insertRow(-1);
                var col1 = linha.insertCell(0);
                var col2 = linha.insertCell(1);
                var col3 = linha.insertCell(2);
                var col4 = linha.insertCell(3);
                var col5 = linha.insertCell(4);
                var col6 = linha.insertCell(5);
                var col7 = linha.insertCell(6);
                var col8 = linha.insertCell(7);
                var col9 = linha.insertCell(8);
                col1.innerHTML = usuario;
                col2.innerHTML = ip;
                col3.innerHTML = musica;
                var st;
                switch(status) {
                    case "0" :
                        st = "Enviando";
                        break;
                    case "1" :
                        st = "Pausado";
                        break;
                    case "2" :
                        st = "Cancelado";
                        break;
                    case "3" :
                        st = "Erro";
                        break;
                    case "4" :
                        st = "Concluído";
                        break;    
                }
                col4.innerHTML = st;
                col5.innerHTML = tamToString(tam);  
                
                var barradownload = document.createElement("div");
                barradownload.className = "downloadbar";
                var barradownloadtamconst = document.createElement("div");
                barradownloadtamconst.className = "dlbarc";
                var porcentagemtamconst = document.createElement("span");
                var porcentagemtamconsttext = document.createTextNode(Number(((enviado / tam) * 100)).toFixed(1) + "%");
                porcentagemtamconst.appendChild(porcentagemtamconsttext);
                barradownloadtamconst.appendChild(porcentagemtamconst);
                barradownload.appendChild(barradownloadtamconst);
                
                var barradownloadtamdin = document.createElement("div");
                barradownloadtamdin.className = "dlbard";
                barradownloadtamdin.style.width = ((enviado / tam) * 100) + "%";
                var porcentagemtamdin = document.createElement("span");
                var porcentagemtamdintext = document.createTextNode(Number(((enviado / tam) * 100)).toFixed(1) + "%");
                porcentagemtamdin.appendChild(porcentagemtamdintext);
                barradownloadtamdin.appendChild(porcentagemtamdin);
                barradownload.appendChild(barradownloadtamdin);
                
                col6.appendChild(barradownload);
                
                col7.innerHTML = tamToString(enviado);
                if(status != 4) col8.innerHTML = "0.0 B/s"; 
            }
            
            function atualizaDownloads(dl) {
                rede = 0;
                for(var i = 0; i < dl.length; i++) {
                    rede += dl[i].taxa;
                    var d = getDownload(dl[i].id);
                    if(d != null) {
                        var linha = document.getElementById("tabeladownloads").rows[d.linhatabela];
                        var barc = linha.cells[5].getElementsByClassName("dlbarc")[0];
                        barc.innerHTML = "<span>" + Number(((dl[i].enviado / d.tamanho) * 100)).toFixed(1) + "%</span>";
                        
                        
                        var bar = linha.cells[5].getElementsByClassName("dlbard")[0];
                        bar.style.width = ((dl[i].enviado / d.tamanho) * 100) + "%";
                        bar.innerHTML = "<span>" + Number(((dl[i].enviado / d.tamanho) * 100)).toFixed(1) + "%</span>";
                        
                        linha.cells[6].innerHTML = tamToString(dl[i].enviado);
                        linha.cells[7].innerHTML = taxaString(dl[i].taxa);
                        
                        var restante = d.tamanho - dl[i].enviado;
                        var segundos = restante / dl[i].taxa;
                        
                        linha.cells[8].innerHTML = tempoString(segundos);
                    }                   
                }
                document.getElementById("taxa").innerHTML = taxaString(rede);
                rede = rede / 1024;
                updateChart();
            }
            
            
            function getDownload(id) {
                for(var i = 0; i < downloads.length; i++) {
                    if(downloads[i].id == id) {
                        return downloads[i];
                    }
                }
                return null;
            }
            
            
            //USUARIOS
            
            function addUser(id, nome, ip, status) {
                var linha = document.getElementById("tabelausuarios").insertRow(-1);
                var col1 = linha.insertCell(0);
                var col2 = linha.insertCell(1);
                var col3 = linha.insertCell(2);
                var col4 = linha.insertCell(3);
                col1.innerHTML = id;
                col2.innerHTML = nome;
                col3.innerHTML = ip;
                col4.innerHTML = status == "on" ? "Online" : "Offline";
                col4.className = status == "on" ? "cellon" : "celloff";
            }
            
            function getUser(id) {
                for(var i = 0; i < usuarios.length; i++) {
                    if(usuarios[i].id == id) {
                        return usuarios[i];
                    }
                }
                return null;
            }
            
            function onlineUser(id, ip) {
                usuario = getUser(id);
                var linha = document.getElementById("tabelausuarios").rows[usuario.linhatabela];
                linha.cells[2].innerHTML = ip;
                linha.cells[3].innerHTML = "Online";
                linha.cells[3].className = "cellon";
            }
            
            function offlineUser(id) {
                usuario = getUser(id);
                var linha = document.getElementById("tabelausuarios").rows[usuario.linhatabela];
                linha.cells[3].innerHTML = "Offline";
                linha.cells[3].className = "celloff";
            }
            
            //LOG
            
            function logLocal(msg) {
                addlog("Web", msg);
            }
            
            function addlog(onde, msg) {
                var rel = new Date();
                var hora = "[" + ("0" + rel.getDate()).slice(-2) + "/" + ("0" + (rel.getMonth() + 1)).slice(-2) + "/" + rel.getFullYear() + " " + ("0" + rel.getHours()).slice(-2) + ":" + ("0" + rel.getMinutes()).slice(-2) + ":" + ("0" + rel.getSeconds()).slice(-2) + "]";
                document.getElementById("logmsg").innerHTML += "<span>" + hora + " &lt;" + onde + "&gt;: " + msg + "</span><br />";
            }
            
            
                      
            //WEBSOCKET
            
            var mySocket = new WebSocket(host + ":" + porta);
            
            function enviarMsg() {
                var texto = document.getElementById("txt").value;
                mySocket.send(texto);
                alert("tam = " + texto.length);
            }
            mySocket.onopen = function(evt) {
                logLocal("WebSocket conectado ao servidor");
                // Enviando dados
                //mySocket.send("c");
                mySocket.send("WebSocket Rocks!");
                // Fecha o WebSocket
                //mySocket.close();
            };
            mySocket.onmessage = function(evt) {
            	var dec = decodeURIComponent(evt.data);
                var obj = JSON.parse(dec);
                switch(obj.cod) {
                    case "1":
                        logLocal("Sincronizando dados com o servidor");
                        musicas = obj.musicas;
                        listaMusicas();
                        usuarios = obj.usuarios;
                        listaUsuarios();
                        downloads = obj.downloads;
                        listaDownloads();
                    break;
                        
                    case "2":
                    break;
                    
                    case "3":
                        switch(obj.param) {
                            case "1":
                                addDownload(obj.usuario, obj.ip, obj.musica, obj.status, obj.tam, obj.enviado);
                                d = downloads[downloads.length] = new Object();
                                d.id = obj.id;
                                d.usuario = obj.usuario;
                                d.ip = obj.ip;
                                d.musica = obj.musica;
                                d.status = obj.status;
                                d.tamanho = obj.tam;
                                d.enviado = obj.enviado;
                                var tabela = document.getElementById("tabeladownloads");
                                var qtdlinhas = tabela.rows.length;
                                d.linhatabela = qtdlinhas - 1;
                            break;
                            case "2": //mostra dowload como finalizado
                                var d = getDownload(obj.id);
                                var linha = document.getElementById("tabeladownloads").rows[d.linhatabela];
                                linha.cells[3].innerHTML = "Concluído";
                                linha.cells[6].innerHTML = linha.cells[4].innerHTML;
                                linha.cells[7].innerHTML = "";
                                linha.cells[8].innerHTML = "";
                                
                                var barc = linha.cells[5].getElementsByClassName("dlbarc")[0];
                                barc.innerHTML = "<span>100%</span>";
                                
                                
                                var bar = linha.cells[5].getElementsByClassName("dlbard")[0];
                                bar.style.width = "100%";
                                bar.innerHTML = "<span>100%</span>";
                            break;
                            case "3":
                                var d = getDownload(obj.id);
                                if(d != null) {
                                     var linha = document.getElementById("tabeladownloads").rows[d.linhatabela];
                                     linha.cells[3].innerHTML = "Pausado";
                                }
                            break;
                            case "4":
                                var d = getDownload(obj.id);
                                if(d != null) {
                                     var linha = document.getElementById("tabeladownloads").rows[d.linhatabela];
                                     linha.cells[3].innerHTML = "Cancelado";
                                }
                            break;
                            case "5":
                                var d = getDownload(obj.id);
                                if(d != null) {
                                     var linha = document.getElementById("tabeladownloads").rows[d.linhatabela];
                                     linha.cells[3].innerHTML = "Erro";
                                }
                            break;
                            case "6":
                                atualizaDownloads(obj.downloads);
                            break;
                        }
                    break;
                    
                    case "4":
                        addlog(obj.quem, obj.msg);
                    break;
                    
                    case "5":
                        switch(obj.param) {
                            case "1":
                                onlineUser(obj.usuario.id, obj.usuario.ip);
                                addlog("RootServer", "---> Usuário conectado (IP: " + obj.usuario.ip + ") ");
                            break;
                            case "2":
                                offlineUser(obj.usuario.id);
                            break;
                        }
                    break;
                    
                    case "6":
                        addUser(obj.id, obj.nome, obj.ip, "off");
                        u = usuarios[usuarios.length] = new Object();
                        u.id = obj.id;
                        u.nome = obj.nome;
                        u.ip = obj.ip;
                        u.status = "off";
                        var tabela = document.getElementById("tabelausuarios");
                        var qtdlinhas = tabela.rows.length;
                        u.linhatabela = qtdlinhas - 1;
                    break;
                }
                // alert("Mensagem recebida: " + evt.data);
            };
            mySocket.onclose = function(evt) {
                logLocal("Conexão com o servidor encerrada");
            };
            mySocket.onerror = function(evt) {
                logLocal("Erro: conexão com o servidor perdida");
            };
            
            function listaMusicas() {
                //limpa tabela
                var tabela = document.getElementById("tabelamusicas");
                var qtdlinhas = tabela.rows.length;
                for(var i = 2; i < qtdlinhas; i++) tabela.deleteRow(i);
                //----
                for(var i = 0; i < musicas.length; i++) {
                    addMusica(musicas[i].id, musicas[i].nome, musicas[i].artista, musicas[i].duracao, musicas[i].tam, musicas[i].path);
                    musicas[i].linhatabela = i + 2;
                }
            }
            
            function listaUsuarios() {
                //limpa tabela
                var tabela = document.getElementById("tabelausuarios");
                var qtdlinhas = tabela.rows.length;
                for(var i = 2; i < qtdlinhas; i++) tabela.deleteRow(i);
                //----
                for(var i = 0; i < usuarios.length; i++) {
                    addUser(usuarios[i].id, usuarios[i].nome, usuarios[i].ip, usuarios[i].status);
                    usuarios[i].linhatabela = i + 2;
                }
            }
            
            function listaDownloads() {
                //limpa tabela
                var tabela = document.getElementById("tabeladownloads");
                var qtdlinhas = tabela.rows.length;
                for(var i = 2; i < qtdlinhas; i++) tabela.deleteRow(i);
                //----
                for(var i = 0; i < downloads.length; i++) {
                    addDownload(downloads[i].usuario, downloads[i].ip, downloads[i].musica, downloads[i].status, downloads[i].tamanho, downloads[i].enviado);
                    downloads[i].linhatabela = i + 2;
                }
                
            }
            
            
            
            //testes
       
            //document.getElementsByTagName("audio")[0].play();
            
            // logLocal("Novo download iniciado");
            // logLocal("Novo download iniciado");
            
        </script>
    </body>
</html>
